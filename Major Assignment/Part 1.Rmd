---
title: "FINAL ASSIGNMENT"
author: "Sumayyah Musa"
date: "3/12/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(cowplot)
library(ggbeeswarm)
library(ggpubr)
library(pastecs)
library(rstatix)
```

## Read in and glimpse the data

```{r}
val_data <- read.csv("wearable_review_data_validity_edited.csv")
```

## Data Cleaning 
### Subsetting the data to select the variables we are interested in

```{r}
new_data <- subset(val_data, Measured != "EE" & Measured != "HR")

glimpse(new_data)
attach(new_data) #attach the data so that the variables can be referred by their column names
```

```{r}
X1 <- as.character(X1)
population_f <- as.numeric(population_f)
population_m <- as.numeric(population_m)
BMI <- as.numeric(BMI)
```

## Data Cleaning by Variable

### AGE

#### Converting age to categorical variable

```{r}
new_data <- new_data %>%
        mutate(age_cat = case_when(
                age_code == "C" ~ "Children",
                age_code == "A" ~ "Adults",
                age_code == "OA" ~ "Older Adults"
        ))
attach(new_data)
```

```{r}
age_cat <- as.factor(age_cat)
addmargins(table(age_cat)) #frequency table of age, including the total

round(prop.table(table(age_cat))*100, digits = 0) #percentage proportion of each category
sum(is.na(age_cat))
```

### GENDER

```{r}
#studies that had equal number of male and female participants were recoded as neutral.
new_data <- new_data %>%
        mutate(gender = case_when(
                population_m > population_f ~ "Male",
                population_m < population_f ~ "Female",
                population_m == population_f ~ "Neutral"
        ))
attach(new_data)
```

```{r}
gender <- as.factor(gender)
addmargins(table(gender))
round(prop.table(table(gender))*100, digits = 0)

sum(is.na(new_data$gender))
new_data <- drop_na(new_data, gender)
```

### BMI

```{r}
summary(BMI)
new_data <- new_data %>%
        mutate(bmi_cat = case_when(
                BMI > 18.5 & BMI < 24.9 ~ "Normal weight",
                BMI > 24.9 & BMI < 29.9 ~ "Overweight",
                BMI > 29.9 ~ "Obese"
        ))
```

```{r}
new_data$bmi_cat <- as.factor(new_data$bmi_cat)
addmargins(table(new_data$bmi_cat))
round(prop.table(table(new_data$bmi_cat))*100, digits = 0) #percentage

sum(is.na(new_data$bmi_cat))
```

### Wear Location

```{r}
new_data$Wear_Location <- as.factor(new_data$Wear_Location)
addmargins(table(new_data$Wear_Location))
round(prop.table(table(new_data$Wear_Location))*100, digits = 0) #percentage

sum(is.na(new_data$Wear_Location))
```

### MPE

```{r}
summary(new_data$MPE)
```

We can remove the missing values

```{r}
#rename our final data as df 
df <- drop_na(new_data, MPE)
```

```{r}
summary(df$MPE)
round(stat.desc(df$MPE),3)
```

Grand mean and median of the MPE are -0.069% and -0.014% respectively, which means that generally the devices were relatively accurate in measuring step count.

```{r}
mpe_hist <- ggplot(df, aes(MPE)) + 
                  geom_histogram(bins = 25) +
                  theme_classic()
                  #facet_wrap(~ age_category)
plot(mpe_hist)
```

The histogram above indicates the presence of potential outliers. The distribution is positively skewed and leptokurtic (the values are closely spread and concentrated around the 0% mark).

```{r}
mpe_box <- ggplot(df, aes(MPE)) + 
                geom_boxplot() +
                coord_flip() +
                theme_classic()
                #facet_wrap(~ age_cat)
plot(mpe_box)
```

This is also evident by the box plot. Let's examine the extreme outliers by using the identify_outlier function.

```{r}
#A dataframe containing the extreme outliers
df_out <- df %>%
  identify_outliers("MPE") %>%
        filter(is.extreme == TRUE)
```

Most of the 110 extreme outliers had the activity type of ADL or walking (overground, treadmill). We will merge the outlier dataframe with our original data

```{r}
total <- merge(df,df_out, all.x = TRUE)
table(total$is.extreme)
```

```{r}
#renaming those no extreme as FALSE instead of NA
total$is.extreme[is.na(total$is.extreme)] <- FALSE
table(total$is.extreme)
```

```{r}
#subsetting the non-outliers in the data
df_val <- subset(total, is.extreme != TRUE)
```

```{r}
summary(df_val$MPE)
table(df_val$MPE_bin)
round(prop.table(table(df_val$MPE_bin))*100, digits = 0) #percentage
```

### Brand

```{r}
df_val$Brand <- as.factor(df_val$Brand)
addmargins(table(df_val$Brand))
round(prop.table(table(df_val$Brand))*100, digits = 0) #percentage

sum(is.na(df_val$Brand))
```

```{r}
df_val <- subset(df_val, Brand != "Mio" & Brand != "Xiaomi")
```

```{r}
mpe_hist_clean <- ggplot(df_val, aes(MPE)) + 
                  geom_histogram(bins = 30) +
                  theme_classic()
                  #facet_wrap(~ age_cat)
plot(mpe_hist_clean)
```

The distribution looks better now that the outliers have been removed

```{r}
mpe_box_clean <- ggplot(df_val, aes(MPE)) + 
                  geom_boxplot() +
                  coord_flip() +
                  theme_classic()
                  #facet_wrap(~ age_cat)
plot(mpe_box_clean)
```

The boxplot is also much better, there is no evidence of extreme outliers.

```{r}
table(df_val$Setting)
round(prop.table(table(df_val$Setting))*100, digits = 0) #percentage

mpe_box_set <- ggplot(df_val, aes(MPE, fill = Setting)) + 
                geom_boxplot() +
                coord_flip() +
                #facet_wrap(~ age_cat) +
                theme_classic()
plot(mpe_box_set)
```

```{r}
mpe_box_brand <- ggplot(df_val, aes(MPE, fill = Brand)) + 
                geom_boxplot() +
                coord_flip() +
                #facet_wrap(~ age_cat) +
                theme_classic()
plot(mpe_box_brand)
```

```{r}
table(df_val$Setting)

df_val %>%
        group_by(Brand, Setting
                 ) %>%
        summarize(count = n())
```

The above shows that only Fitbit has enough studies in free living conditions to examine for validity, while all brands except from Mio and Xiaomi have enough studies in controlled setting.

## Filtering data for plotting
### Summary statistics by the groups

```{r}
#By age
df_val %>%
        group_by(age_cat, Setting
                 ) %>%
        get_summary_stats(MPE, type = "mean_sd")
```

```{r}
#By gender
df_val %>%
        group_by(gender, Setting) %>%
        get_summary_stats(MPE, type = "mean_sd")
```

```{r}
#by BMI
df_val %>%
        group_by(bmi_cat, Setting) %>%
        get_summary_stats(MPE, type = "mean_sd")
```

```{r}
#by wear location
df_val %>%
        group_by(Wear_Location, Setting) %>%
        get_summary_stats(MPE, type = "mean_sd")
```

```{r}
#relevel factors
df_val$age_cat <- fct_relevel(df_val$age_cat, c("Children","Adults","Older Adults"))
df_val$gender <- fct_relevel(df_val$gender, c("Female","Male","Neutral"))
df_val$bmi_cat <- fct_relevel(df_val$bmi_cat, c("Normal weight","Overweight","Obese"))
df_val$Wear_Location <- fct_relevel(df_val$Wear_Location, c("Wrist","Waist/Hip","Torso","LAF","Upper Arm", "Thigh"))
```

# Filter MPE by setting and removing those with less than 10 comparisons

```{r}
df_val_control <- filter(df_val, Setting == "Controlled", Wear_Location != "Thigh", Wear_Location != "Upper Arm")
df_val_free <- filter(df_val, Setting == "Free-Living", age_cat != "Children", gender != "Neutral", Wear_Location != "LAF", Wear_Location != "Torso")
```

## Controlled setting
### Validity of Step count in controlled setting - Overall

```{r}
addmargins(table(df_val_control$MPE_bin))
round(prop.table(table(df_val_control$MPE_bin))*100, digits = 0) #percentage

summary(df_val_control$MPE)
```

The overall tendency was to underestimate step count in control setting (mean = -0.04%, median = -0.01%)

## Free living setting
### Validity of Step count in free living setting - Overall

```{r}
addmargins(table(df_val_free$MPE_bin))
round(prop.table(table(df_val_free$MPE_bin))*100, digits = 0) #percentage

summary(df_val_free$MPE)
```

The overall tendency was to accurately estimate step count in free living setting (mean = 0.0009%, median = 0.02%)

## MPE plot by number of participants (n) analyzed for Step count
### Percentage error distribution by sample size in controlled settings for each measure

* Solid grey lines indicate mean error
* Dashed grey lines indicate 95% CI

```{r}
mpe_n_control <- ggplot(df_val_control, aes(x = actual_n_analyzed, y = MPE)) +
                    geom_point(shape = 16, alpha = 0.5, size = 2) +
                    scale_y_continuous(#breaks = seq(-0.1, 0.1, 0.01), 
                      limits = c(-0.5, 0.5), #labels=percent
                                       ) +
                    geom_hline(yintercept = 0) +
                    geom_hline(yintercept = mean(df_val_control$MPE), colour = "grey") +
                    geom_hline(yintercept = (mean(df_val_control$MPE) + 
                                               1.96*sd(df_val_control$MPE)), 
                                              linetype = "dashed", colour = "grey", size = 0.5) +
                    geom_hline(yintercept = (mean(df_val_control$MPE) - 
                                               1.96*sd(df_val_control$MPE)), 
                                                linetype = "dashed", colour = "grey", size = 0.5) +
                    scale_x_continuous(breaks = seq(0, 180, 30), limits = c(0, 180)) +
                    theme_classic() +
                    theme(plot.title = element_text(hjust = 0.5)) +
                    xlab("Number of Participants") +
                    ylab("Step MPE (%)")
plot(mpe_n_control)
```

### Free living Setting

```{r}
mpe_n_free <- ggplot(df_val_free, aes(x = actual_n_analyzed, y = MPE)) +
                    geom_point(shape = 16, alpha = 0.5, size = 2) +
                    scale_y_continuous(#breaks = seq(-0.1, 0.1, 0.01), 
                      limits = c(-0.5, 0.5), #labels=percent
                                       ) +
                    geom_hline(yintercept = 0) +
                    geom_hline(yintercept = mean(df_val_free$MPE), colour = "grey") +
                    geom_hline(yintercept = (mean(df_val_free$MPE) + 
                                               1.96*sd(df_val_free$MPE)), 
                                              linetype = "dashed", colour = "grey", size = 0.5) +
                    geom_hline(yintercept = (mean(df_val_free$MPE) - 
                                               1.96*sd(df_val_free$MPE)), 
                                                linetype = "dashed", colour = "grey", size = 0.5) +
                    scale_x_continuous(breaks = seq(0, 180, 30), limits = c(0, 180)) +
                    theme_classic() +
                    theme(plot.title = element_text(hjust = 0.5)) +
                    xlab("Number of Participants") +
                    ylab("Step MPE (%)")
plot(mpe_n_free)
```

```{r}
figure1 <- plot_grid(mpe_n_control, mpe_n_free, labels = c('A', 'B'), label_size = 12)
plot(figure1)
```

```{r}
ggsave("figure1.pdf", plot = figure1, width = 8.5, height = 6)
```

## Controlled Setting
### Validity of Step count by Age in Controlled setting
* Dashed grey lines indicate ± 3% measurement error

```{r}
#options(repr.plot.width = 25, repr.plot.height = 8)
df_val_agecontrol_plot <- ggplot(df_val_control, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.03, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.03, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.1, 0.1), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ age_cat)
plot(df_val_agecontrol_plot)
```
### Validity of step count by gender in controlled setting

```{r}
df_val_sexcontrol_plot <- ggplot(df_val_control, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.03, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.03, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.1, 0.1), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ gender)
plot(df_val_sexcontrol_plot)
```

### Validity of step count by BMI in controlled setting

```{r}
df_val_bmicontrol_plot <- ggplot(df_val_control, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.03, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.03, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.1, 0.1), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ bmi_cat)
plot(df_val_bmicontrol_plot)
```

### Validity of step count by Wear location in controlled setting

```{r}
df_val_wlcontrol_plot <- ggplot(df_val_control, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.03, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.03, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.1, 0.1), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ Wear_Location)
plot(df_val_wlcontrol_plot)
```

```{r}
figure2 <- plot_grid(df_val_agecontrol_plot, df_val_sexcontrol_plot, df_val_bmicontrol_plot, df_val_wlcontrol_plot,
                     labels = c('A','B','C','D'), label_size = 12)
plot(figure2)
```

```{r}
ggsave("figure2.pdf", plot = figure2, width = 18, height = 16)
```

## Free living Setting
### Validity of Step count by Age in free living setting
* Dashed grey lines indicate ± 10% measurement error

```{r}
df_val_agefree_plot <- ggplot(df_val_free, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.1, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.1, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.2, 0.2), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ age_cat)
plot(df_val_agefree_plot)
```

### Validity of step count by gender in free living setting

```{r}
df_val_sexfree_plot <- ggplot(df_val_free, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.1, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.1, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.2, 0.2), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ gender)
plot(df_val_sexfree_plot)
```

### Validity of step count by BMI in free living setting

```{r}
df_val_bmifree_plot <- ggplot(df_val_free, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.1, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.1, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.2, 0.2), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ bmi_cat)
plot(df_val_bmifree_plot)
```

### Validity of step count by Wear location in fee living setting

```{r}
df_val_wlfree_plot <- ggplot(df_val_free, aes(x = Brand, y = MPE, colour = Brand)) +
                    geom_boxplot() +
                    geom_beeswarm(dodge.width = 0.2, cex = 0.2, alpha = 0.08) +   
                    geom_hline(yintercept = 0) +  
                    geom_hline(yintercept = 0.1, size = 0.5, colour = "grey", linetype = "dashed") + 
                    geom_hline(yintercept = -0.1, size = 0.5, colour = "grey", linetype = "dashed") +   
                    scale_y_continuous(limits=c(-0.2, 0.2), #labels = percent
                                       ) +
                    ylab("Step MPE (%)") +
                    scale_colour_brewer(palette="Dark2") +
                    theme_bw() +
                    theme(axis.text.x = element_text(colour = "grey20", size = 10, angle = 90, hjust = 0.5, 
                                                     vjust = 0.5),
                        axis.text.y = element_text(colour = "grey20", size = 10),
                        strip.text = element_text(face = "italic"),
                        text = element_text(size = 12)) +
                    facet_wrap(~ Wear_Location)
plot(df_val_wlfree_plot)
```

```{r}
figure3 <- plot_grid(df_val_agefree_plot, df_val_sexfree_plot, df_val_bmifree_plot, df_val_wlfree_plot, labels = c('A','B','C','D'), label_size = 12)
plot(figure3)
```

```{r}
ggsave("figure3.pdf", plot = figure3, width = 18, height = 16)
```

## Comparing Means between population groups
### Computing Kruskal Wallis Test

We want to know if there is any significant differences between the mean Step MPE of the different population groups generally.

### Age

```{r}
kruskal.test(MPE ~ age_cat, data = df_val)
```

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the age groups.

```{r}
df_val %>% kruskal_effsize(MPE ~ age_cat)
```

The effect size of 0.041, which is small, means that 4.1% of the change in the Step MPE can be accounted for by age.

From the output of the Kruskal-Wallis test, we know that there is a significant difference between the age groups, but we don’t know which pairs of groups are different.

```{r}
# Pairwise comparisons
pwc_age <- df_val %>% 
  dunn_test(MPE ~ age_cat, p.adjust.method = "bonferroni") 
pwc_age
```

```{r}
# Visualization: box plots with significance
pwc_age <- pwc_age %>% add_xy_position(x = "age_cat")
age_sig <- ggboxplot(df_val, x = "age_cat", y = "MPE") +
  stat_pvalue_manual(pwc_age, hide.ns = TRUE) +
  labs(caption = get_pwc_label(pwc_age))
plot(age_sig)
```

There was a statistically significant difference between age groups as assessed using the Kruskal-Wallis test (p = 1.344e-07). Pairwise Dunn's test between groups showed that only the differences between children and older adults (Dunn’s test, p = 0.006), and between adults and older adults (Dunn's test, p = 1.24e-07) were significant.

### Gender

```{r}
kruskal.test(MPE ~ gender, data = df_val)
```

As the p-value is greater than the significance level 0.05, we can conclude that there are no significant differences between the gender groups.

```{r}
df_val %>% kruskal_effsize(MPE ~ gender)
```

The effect size of 0.0029, which is very small, means that 0.29% of the change in the Step MPE can be accounted for by gender.

```{r}
# Pairwise comparisons
pwc_sex <- df_val %>% 
  dunn_test(MPE ~ gender, p.adjust.method = "bonferroni") 
pwc_sex
```

This confirms that there is no significant differences between the gender.

```{r}
# Visualization: box plots with significance
pwc_sex <- pwc_sex %>% add_xy_position(x = "gender")
sex_sig <- ggboxplot(df_val, x = "gender", y = "MPE") +
  stat_pvalue_manual(pwc_sex, hide.ns = TRUE) +
  labs(caption = get_pwc_label(pwc_sex))
plot(sex_sig)
```

### BMI

```{r}
kruskal.test(MPE ~ bmi_cat, data = df_val)
```

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the bmi groups.

```{r}
df_val %>% kruskal_effsize(MPE ~ bmi_cat)
```
The effect size of 0.045, which is small, means that 4.5% of the change in the Step MPE can be accounted for by BMI.

From the output of the Kruskal-Wallis test, we know that there is a significant difference between the BMI groups, but we don’t know which pairs of groups are different.

```{r}
# Pairwise comparisons
pwc_bmi <- df_val %>% 
  dunn_test(MPE ~ bmi_cat, p.adjust.method = "bonferroni") 
pwc_bmi
```

```{r}
# Visualization: box plots with significance
pwc_bmi <- pwc_bmi %>% add_xy_position(x = "bmi_cat")
bmi_sig <- ggboxplot(df_val, x = "bmi_cat", y = "MPE") +
  stat_pvalue_manual(pwc_bmi, hide.ns = TRUE) +
  labs(caption = get_pwc_label(pwc_bmi))
plot(bmi_sig)
```

There was a statistically significant difference between bmi groups as assessed using the Kruskal-Wallis test (p = 2.073e-08). Pairwise Dunn's test between groups showed that only the differences between normal weight and overweight (Dunn’s test, p = 2.45e-08), and between normal weight and obese (Dunn's test, p = 6.00e-04) were significant.

### Wear Location

```{r}
kruskal.test(MPE ~ Wear_Location, data = df_val)
```

As the p-value is less than the significance level 0.05, we can conclude that there are significant differences between the wear location groups.

```{r}
df_val %>% kruskal_effsize(MPE ~ Wear_Location) #effect size
```

The effect size of 0.009, which is small, means that 0.9% of the change in the Step MPE can be accounted for by the part of the body it is worn.

From the output of the Kruskal-Wallis test, we know that there is a significant difference between the Wear location groups, but we don’t know which pairs of groups are different.

```{r}
# Pairwise comparisons
pwc_wl <- df_val %>% 
  dunn_test(MPE ~ Wear_Location, p.adjust.method = "bonferroni") 
pwc_wl
```

The above shows that there are no statistically significant differences in the step MPE between the wear location groups. 

```{r}
# Visualization: box plots with significance
pwc_wl <- pwc_wl %>% add_xy_position(x = "Wear_Location")
wl_sig <- ggboxplot(df_val, x = "Wear_Location", y = "MPE") +
  stat_pvalue_manual(pwc_wl, hide.ns = TRUE) +
  labs(caption = get_pwc_label(pwc_wl))
plot(wl_sig)
```


```{r}
figure4 <- plot_grid(age_sig,sex_sig,bmi_sig,wl_sig, labels = c('A','B','C','D'), label_size = 12)
plot(figure4)
```

```{r}
ggsave("figure4.pdf", plot = figure4, width = 10, height = 7)
```

### ANOVA using all population groups as factor

```{r}
mpe_aov <- aov(MPE ~ age_cat*gender*bmi_cat*Wear_Location, data = df_val)
summary(mpe_aov)
```

Age and BMI have the greatest influence on MPE, followed by BMI, then gender and wear location.













